# 根本原因分析（最终版）

## 🔴 关键发现

### Frame 90 的详细数据

#### 左腿动作值（处理后）：
- left_hip_pitch: -0.5884
- left_hip_roll: -0.1216
- left_hip_yaw: 0.9324
- left_knee: -0.1170
- left_ankle_pitch: -1.7250
- left_ankle_roll: -0.8743
- **平均幅度：0.7264**

#### 右腿动作值（处理后）：
- right_hip_pitch: 1.8011
- right_hip_roll: -0.8036
- right_hip_yaw: -0.5803
- right_knee: -0.4613
- **right_ankle_pitch: 10.3132** ⚠️ **异常大！**
- right_ankle_roll: -0.6617
- **平均幅度：2.4369**

---

## ✅ 已确认的事实

1. ✅ **action_scale 对称**：左右腿都是 0.55
2. ✅ **代码处理逻辑正确**：原始动作和处理后动作相同（clip 未生效，因为 action_clip=100）
3. ❌ **策略输出本身就不对称**：
   - 左腿原始平均：0.7264
   - 右腿原始平均：2.4369
   - 对称性比例：0.2981（严重不对称）

---

## 🔍 根本原因

### 问题1：策略输出异常
**右腿 ankle_pitch 关节输出异常大的值：10.3132**

这个值：
- 远超正常范围（正常应该在 [-2, 2] 左右）
- 是左腿对应关节（-1.7250）的约 6 倍
- 导致右腿整体动作异常大

### 问题2：动作不对称
**策略输出的原始动作值就不对称**，说明：
- 不是代码处理的问题
- 不是 action_scale 的问题
- **是策略模型本身的问题**

---

## 💡 可能的原因

### 原因1：策略模型训练问题
- 策略在训练时可能没有充分学习对称性
- 或者训练数据本身就不对称

### 原因2：观察向量不对称
- 虽然初始状态对称，但运行时观察向量可能变得不对称
- 特别是 `JointVel`、`JointPosRel`、`PrevActions` 等组件

### 原因3：LSTM 状态问题
- LSTM 的内部状态可能没有正确初始化
- 或者 warmup 不够充分

### 原因4：策略模型本身的问题
- 模型可能在某些情况下会输出异常大的值
- 需要检查原始 Python 策略是否也有这个问题

---

## 🔧 解决方案

### 方案1：检查观察向量（优先）
在运行时检查观察向量是否对称，特别是：
- `JointVel`（关节速度）
- `JointPosRel`（关节位置相对值）
- `PrevActions`（前一步动作）

如果观察向量不对称，策略输出也会不对称。

### 方案2：增强动作 clip
虽然 `action_clip=100`，但策略输出 10.3132 仍然太大。
可以考虑：
- 降低 `action_clip` 到更合理的值（如 5.0）
- 或者在应用 `action_scale` 之前先 clip

### 方案3：检查策略模型
- 检查原始 Python 策略是否也有这个问题
- 如果原始策略正常，说明转换过程有问题
- 如果原始策略也有问题，说明策略本身需要重新训练

### 方案4：调整 action_scale
虽然 action_scale 对称，但可以考虑：
- 降低 action_scale（当前是 0.55）
- 或者对异常大的动作值使用更小的 scale

---

## 📋 下一步行动

### 立即检查：观察向量对称性

在运行时检查观察向量是否对称，特别是 `JointVel`、`JointPosRel`、`PrevActions`。

如果观察向量不对称，那就是问题的根源。

### 临时修复：增强动作 clip

降低 `action_clip` 到更合理的值（如 5.0），防止异常大的动作值。

---

## 🎯 关键结论

1. **问题不在代码处理逻辑**：action_scale 对称，处理逻辑正确
2. **问题在策略输出**：策略输出的原始动作值就不对称
3. **右腿 ankle_pitch 异常**：输出 10.3132，远超正常范围
4. **需要检查观察向量**：如果观察向量不对称，策略输出也会不对称

---

## 📊 数据总结

| 项目 | 左腿 | 右腿 | 对称性 |
|------|------|------|--------|
| 原始动作平均 | 0.7264 | 2.4369 | 0.2981 ❌ |
| 处理后动作平均 | 0.7264 | 2.4369 | 0.2981 ❌ |
| action_scale | 0.55 | 0.55 | ✅ 对称 |
| 最大动作值 | -1.7250 | **10.3132** | ❌ 异常 |

**结论**：策略输出本身就不对称，特别是右腿 ankle_pitch 关节输出异常大的值。

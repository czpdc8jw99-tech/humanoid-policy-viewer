# 步骤2实施：验证策略响应

## 🎯 目标

验证策略在接收到非零命令时是否输出不同的动作，并测试机器人是否能够行走。

---

## ✅ 已添加的功能

### UI 测试控件

在策略选择为 "G1 Locomotion (Gamepad)" 时，会显示测试命令控件：

1. **三个输入框**：
   - Vx（前进速度）：范围 [-0.4, 0.7]
   - Vy（侧向速度）：范围 [-0.4, 0.4]
   - Wz（转向速度）：范围 [-1.57, 1.57]

2. **快捷按钮**：
   - **Stop**：设置命令为 [0.0, 0.0, 0.0]
   - **Forward**：设置命令为 [0.3, 0.0, 0.0]（前进）
   - **Turn L**：设置命令为 [0.0, 0.0, 0.5]（左转）
   - **Turn R**：设置命令为 [0.0, 0.0, -0.5]（右转）

3. **当前命令显示**：
   - 显示当前设置的命令值

### 功能说明

- **自动应用**：当输入框值改变时，自动应用到策略
- **优先级**：如果手柄已连接，手柄命令优先；否则使用测试命令
- **实时更新**：命令值实时传递到策略

---

## 📋 测试步骤

### 步骤2.1：加载策略

1. **选择策略**：
   - 在策略下拉菜单中选择 "G1 Locomotion (Gamepad)"
   - 等待策略加载完成

2. **确认测试控件显示**：
   - 应该看到 "Test Commands" 部分
   - 应该看到三个输入框和四个按钮

---

### 步骤2.2：测试零命令（停止）

1. **设置零命令**：
   - 点击 "Stop" 按钮
   - 或者手动设置 Vx=0, Vy=0, Wz=0

2. **启动模拟**：
   - 点击播放按钮启动模拟

3. **观察机器人**：
   - 观察机器人是否能够稳定站立
   - 观察动作值（在控制台查看监控输出）

4. **记录结果**：
   - 机器人是否能够稳定站立？
   - 动作是否对称？
   - 是否有异常大的动作值？

---

### 步骤2.3：测试前进命令

1. **设置前进命令**：
   - 点击 "Forward" 按钮（设置 Vx=0.3）
   - 或者手动设置 Vx=0.3, Vy=0, Wz=0

2. **启动模拟**：
   - 点击播放按钮启动模拟

3. **观察机器人**：
   - 观察机器人是否尝试向前移动
   - 观察机器人是否能够保持平衡
   - 观察动作值变化

4. **记录结果**：
   - 机器人是否向前移动？
   - 机器人是否能够保持平衡？
   - 动作值是否与零命令时不同？
   - 动作是否对称（多步平均）？

---

### 步骤2.4：测试不同速度

1. **测试低速**：
   - 设置 Vx=0.1, Vy=0, Wz=0
   - 观察机器人行为

2. **测试中速**：
   - 设置 Vx=0.3, Vy=0, Wz=0
   - 观察机器人行为

3. **测试高速**：
   - 设置 Vx=0.5, Vy=0, Wz=0
   - 观察机器人行为

4. **对比结果**：
   - 不同速度下机器人行为是否不同？
   - 速度越快，动作幅度是否越大？
   - 机器人是否都能保持平衡？

---

### 步骤2.5：测试转向命令

1. **测试左转**：
   - 点击 "Turn L" 按钮（设置 Wz=0.5）
   - 或者手动设置 Vx=0, Vy=0, Wz=0.5
   - 观察机器人是否转向

2. **测试右转**：
   - 点击 "Turn R" 按钮（设置 Wz=-0.5）
   - 或者手动设置 Vx=0, Vy=0, Wz=-0.5
   - 观察机器人是否转向

3. **测试前进+转向**：
   - 设置 Vx=0.3, Vy=0, Wz=0.5
   - 观察机器人是否同时前进和转向

---

## 🔍 验证方法

### 方法1：通过UI观察

- 观察机器人的行为
- 观察是否能够行走
- 观察是否能够保持平衡

### 方法2：通过控制台监控

**在浏览器控制台运行**：

```javascript
// 检查当前命令
const demo = window.demo;
console.log('Current command:', Array.from(demo.cmd));

// 检查策略命令
const pr = demo.policyRunner || demo.policyRunners?.[0];
console.log('Policy command:', Array.from(pr.command));

// 检查动作值
console.log('Last actions:', Array.from(pr.lastActions));

// 检查动作对称性
const leftIndices = [0, 3, 6, 9, 13, 17];
const rightIndices = [1, 4, 7, 10, 14, 18];
const leftAvg = leftIndices.reduce((sum, i) => sum + Math.abs(pr.lastActions[i]), 0) / leftIndices.length;
const rightAvg = rightIndices.reduce((sum, i) => sum + Math.abs(pr.lastActions[i]), 0) / rightIndices.length;
const ratio = Math.min(leftAvg, rightAvg) / Math.max(leftAvg, rightAvg);
console.log('Action symmetry:', { leftAvg, rightAvg, ratio });
```

---

## ✅ 验证清单

完成步骤2后，应该确认：

- [ ] 测试控件正常显示和工作
- [ ] 命令值可以正常设置
- [ ] 命令值正确传递到策略
- [ ] 零命令时机器人行为（可能不稳定）
- [ ] 非零命令时机器人行为（应该尝试移动）
- [ ] 不同命令值产生不同的行为
- [ ] 机器人是否能够行走
- [ ] 机器人是否能够保持平衡

---

## 🔧 如果验证失败

### 问题1：测试控件不显示

**可能原因**：
- 策略未选择为 "G1 Locomotion (Gamepad)"
- UI 条件判断错误

**解决方法**：
- 确保选择了正确的策略
- 检查浏览器控制台是否有错误

### 问题2：命令值不生效

**可能原因**：
- 命令未正确传递到策略
- 策略未正确处理命令

**解决方法**：
- 检查控制台中的命令值
- 检查策略是否正确加载

### 问题3：机器人无法行走

**可能原因**：
- 动作值过大或过小
- 动作不对称
- 策略参数不合适

**解决方法**：
- 检查动作值范围
- 检查动作对称性
- 调整策略参数（action_scale, action_clip）

---

## 📝 下一步

完成步骤2后，根据测试结果决定：
- 如果机器人能够行走 → 继续优化
- 如果机器人无法行走 → 进入步骤4（问题修复）

---

## 🎯 预期结果

### 理想状态

1. ✅ **机器人能够响应命令**：设置非零命令时，机器人尝试移动
2. ✅ **机器人能够行走**：设置前进命令时，机器人向前行走
3. ✅ **机器人能够保持平衡**：行走时能够保持平衡

### 可能的问题

1. ⚠️ **机器人无法稳定站立**：零命令时不稳定（这是预期的，因为策略是为行走设计的）
2. ⚠️ **行走时动作过大**：需要调整 action_scale 或 action_clip
3. ⚠️ **行走时仍然不对称**：需要强制对称化或调整参数

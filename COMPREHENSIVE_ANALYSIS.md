# 综合分析报告

## 🔴 根本原因确认

### 关键数据（Frame 90）

#### 动作值对比
| 关节 | 左腿 | 右腿 | 差异 |
|------|------|------|------|
| hip_pitch | -0.5884 | 1.8011 | 右腿大 |
| hip_roll | -0.1216 | -0.8036 | 接近 |
| hip_yaw | 0.9324 | -0.5803 | 接近 |
| knee | -0.1170 | -0.4613 | 接近 |
| **ankle_pitch** | **-1.7250** | **10.3132** | **右腿异常大！** |
| ankle_roll | -0.8743 | -0.6617 | 接近 |

#### 关键发现
1. ✅ **action_scale 对称**：都是 0.55
2. ✅ **代码处理正确**：原始动作和处理后动作相同
3. ❌ **策略输出不对称**：
   - 左腿平均：0.7264
   - 右腿平均：2.4369
   - 对称性比例：0.2981
4. 🔴 **右腿 ankle_pitch 异常**：10.3132（远超正常范围）

---

## 💡 问题根源分析

### 已排除的原因
1. ✅ **代码处理逻辑**：action_scale 对称，处理逻辑正确
2. ✅ **动作映射**：action_scale 对称，映射应该正确
3. ✅ **初始状态**：所有初始检查都正常

### 可能的原因（按优先级）

#### 原因1：观察向量不对称（最可能）
**假设**：运行时观察向量（JointVel, JointPosRel, PrevActions）变得不对称，导致策略输出不对称。

**验证方法**：已添加观察向量对称性检查到监控代码中。

**如果确认**：
- 需要检查为什么观察向量会不对称
- 可能是关节速度/位置不对称导致的
- 需要修复观察向量的计算或来源

#### 原因2：策略模型本身的问题
**假设**：策略模型在训练时没有充分学习对称性，或者在某些输入下会输出异常大的值。

**验证方法**：
- 检查原始 Python 策略是否也有这个问题
- 如果原始策略正常，说明转换过程有问题
- 如果原始策略也有问题，说明策略本身需要重新训练

#### 原因3：LSTM 状态问题
**假设**：LSTM 的内部状态没有正确初始化，导致输出不稳定。

**验证方法**：
- 检查 warmup 是否充分
- 检查 LSTM 状态是否正确传递

---

## 🔧 解决方案

### 方案1：降低 action_clip（临时修复）
**当前**：`action_clip: 100.0`
**建议**：降低到 `5.0` 或 `3.0`

这样可以防止异常大的动作值（如 10.3132）被应用到机器人。

**风险**：可能会限制正常动作的范围。

### 方案2：检查观察向量对称性（根本修复）
**已实现**：监控代码会自动检查观察向量对称性。

**如果观察向量不对称**：
- 检查 `JointVel` 的来源（`state.jointVel`）
- 检查 `JointPosRel` 的计算
- 检查 `PrevActions` 的更新

### 方案3：调整 action_scale
**当前**：`action_scale: 0.55`（标量）

可以考虑：
- 进一步降低到 `0.4` 或 `0.3`
- 或者对异常大的动作值使用更小的 scale

---

## 📋 下一步行动

### 立即执行
1. **等待部署完成**（约 1-2 分钟）
2. **刷新页面**（F5）
3. **加载策略并启动模拟**
4. **查看监控输出**：当检测到动作不对称时，会自动输出：
   - 观察向量对称性检查（JointPosRel, JointVel, PrevActions）
   - 原始动作对称性
   - action_scale 对称性

### 根据监控结果决定

#### 如果观察向量不对称
→ 修复观察向量的计算或来源

#### 如果观察向量对称但动作不对称
→ 说明是策略模型本身的问题
→ 需要检查原始 Python 策略或重新训练

#### 如果右腿 ankle_pitch 持续异常大
→ 临时修复：降低 `action_clip` 到 5.0
→ 根本修复：检查为什么策略会输出这么大的值

---

## 🎯 关键结论

1. **问题不在代码处理**：action_scale 对称，处理逻辑正确
2. **问题在策略输出**：策略输出的原始动作值就不对称
3. **右腿 ankle_pitch 异常**：输出 10.3132，远超正常范围
4. **需要检查观察向量**：如果观察向量不对称，策略输出也会不对称

---

## 📊 数据总结

| 项目 | 左腿 | 右腿 | 状态 |
|------|------|------|------|
| 原始动作平均 | 0.7264 | 2.4369 | ❌ 不对称 |
| action_scale | 0.55 | 0.55 | ✅ 对称 |
| 最大动作值 | -1.7250 | **10.3132** | ❌ 异常 |
| 对称性比例 | 0.2981 | 0.2981 | ❌ 严重不对称 |

**下一步**：等待部署完成，查看观察向量对称性检查结果。

# 策略调用诊断指南

## 🎯 目标

验证策略是否正确加载、命令是否正确传递、策略是否正确推理、动作是否正确应用。

---

## 📋 诊断步骤

### 步骤1：打开浏览器控制台

1. **打开网页**：https://czpdc8jw99-tech.github.io/humanoid-policy-viewer/
2. **打开控制台**：按 `F12` 或右键 → "检查" → "Console" 标签
3. **清空控制台**：点击清空按钮（🚫）或按 `Ctrl+L`

---

### 步骤2：加载策略

1. **选择策略**：在策略下拉菜单中选择 **"G1 Locomotion (Gamepad)"**
2. **等待加载完成**：看到 `[PolicyRunner] Policy initialized` 日志

**✅ 应该看到的日志**：
```
[PolicyRunner] Policy initialized - Debug logs will appear below
[PolicyRunner] Policy initialized: { numActions: 29, numObs: 96, ... }
```

**❌ 如果没有看到**：策略可能没有正确加载

---

### 步骤3：设置测试命令

1. **点击 "Forward" 按钮**（设置 Vx=0.3）
2. **查看控制台**：应该看到以下日志

**✅ 应该看到的日志**：
```
=== [测试命令] 设置命令值 ===
命令值: [0.3, 0, 0]
demo是否存在: true
demo.cmd是否存在: true
[TestCommand] 单机器人模式，命令已设置: [0.3, 0, 0]
```

**❌ 如果没有看到**：
- `demo不存在` → 页面未正确初始化
- `策略不存在或没有setCommand方法` → 策略未正确加载

---

### 步骤4：启动模拟

1. **点击播放按钮**（▶️）启动模拟
2. **立即查看控制台**：应该看到以下诊断日志

**✅ 应该看到的日志（按顺序）**：

#### 4.1 策略调用诊断
```
=== [策略调用诊断] 检查策略是否正确调用 ===
1. 策略加载状态: {
  hasPolicyRunner: true,
  isMultiRobot: false,
  policyRunnerExists: true,
  ...
}
2. 当前命令值: {
  demoCmd: [0.3, 0, 0],
  cmdMagnitude: 0.3
}
3. 单机器人策略状态: {
  exists: true,
  hasSetCommand: true,
  hasStep: true,
  command: [0.3, 0, 0],
  ...
}
```

**❌ 如果看到**：
- `hasPolicyRunner: false` → 策略未加载
- `policyRunnerExists: false` → 策略对象不存在
- `hasSetCommand: false` → 策略没有setCommand方法
- `hasStep: false` → 策略没有step方法

#### 4.2 命令验证
```
=== [命令验证] setCommand后的命令值 ===
策略中的命令: [0.3, 0, 0]
demo.cmd: [0.3, 0, 0]
命令是否匹配: ✅
```

**❌ 如果看到**：
- `命令是否匹配: ❌` → 命令未正确传递到策略

#### 4.3 推理结果
```
=== [推理结果] step()返回的actionTarget ===
actionTarget是否存在: true
actionTarget类型: object
actionTarget是否为数组: true
actionTarget是否为Float32Array: true
actionTarget长度: 29
actionTarget前6个值: [...]
actionTarget范围: { min: ..., max: ..., avg: ... }
```

**❌ 如果看到**：
- `actionTarget是否存在: false` → 策略推理失败
- `actionTarget长度为0` → 策略返回空结果
- `actionTarget范围全为0` → 策略输出全为零（可能有问题）

#### 4.4 动作应用
```
=== [动作应用] 检查actionTarget是否被应用 ===
actionTarget是否存在: true
actionTarget长度: 29
ctrl_adr_policy长度: 29
前6个关节的目标位置: [...]
```

**❌ 如果看到**：
- `actionTarget不存在` → 动作未生成
- `ctrl_adr_policy长度为0` → 关节映射未正确设置

#### 4.5 控制应用
```
=== [控制应用] 检查控制值是否被应用到MuJoCo ===
ctrl_adr_policy长度: 29
actionTarget长度: 29
第一个关节的控制值: {
  policyIdx: 0,
  jointName: "left_hip_pitch_joint",
  targetJpos: ...,
  currentQpos: ...,
  kp: ...,
  kd: ...,
  torque: ...,
  ctrlAdr: ...,
  ctrlValueBefore: ...
}
```

**❌ 如果看到**：
- `kp为0` → PD增益未正确设置
- `torque为0` → 控制力矩为零（可能无法控制机器人）

#### 4.6 控制验证
```
=== [控制验证] 检查控制值是否被设置 ===
第一个执行器的控制值: {
  ctrlAdr: ...,
  ctrlValue: ...,
  isZero: ✅ 非零
}
```

**❌ 如果看到**：
- `isZero: ⚠️ 为零` → 控制值未被设置（机器人无法被控制）

---

## 🔍 常见问题诊断

### 问题1：机器人直接倒了

**可能原因**：
1. ❌ **策略未加载** → 检查步骤2的日志
2. ❌ **策略推理失败** → 检查步骤4.3的日志
3. ❌ **动作未应用** → 检查步骤4.4的日志
4. ❌ **控制值未设置** → 检查步骤4.6的日志
5. ⚠️ **PD增益为0** → 检查步骤4.5的日志（kp/kd）

**解决方法**：
- 根据日志找到具体问题点
- 如果策略未加载 → 检查策略文件路径
- 如果推理失败 → 检查ONNX模型是否正确
- 如果控制值未设置 → 检查关节映射

---

### 问题2：控制基本没有

**可能原因**：
1. ❌ **命令未传递** → 检查步骤3和4.2的日志
2. ❌ **策略输出全为0** → 检查步骤4.3的日志（actionTarget范围）
3. ⚠️ **PD增益太小** → 检查步骤4.5的日志（kp值）
4. ⚠️ **动作值被裁剪** → 检查步骤4.3的日志（actionTarget范围）

**解决方法**：
- 如果命令未传递 → 检查 `onTestCommandChange` 方法
- 如果策略输出全为0 → 检查策略是否正确加载
- 如果PD增益太小 → 检查策略配置文件中的 `kp` 值

---

## 📊 诊断检查清单

完成诊断后，请确认：

- [ ] ✅ 策略已正确加载（步骤2）
- [ ] ✅ 命令已正确设置（步骤3）
- [ ] ✅ 策略已正确调用（步骤4.1）
- [ ] ✅ 命令已正确传递（步骤4.2）
- [ ] ✅ 策略推理成功（步骤4.3）
- [ ] ✅ 动作已正确应用（步骤4.4）
- [ ] ✅ 控制值已正确计算（步骤4.5）
- [ ] ✅ 控制值已正确设置（步骤4.6）

---

## 🎯 下一步

根据诊断结果：

### 如果所有检查都通过 ✅

→ 问题可能在策略本身（动作值不合适、PD增益不合适等）
→ 进入步骤4：问题修复

### 如果有检查失败 ❌

→ 根据失败的检查点修复代码
→ 重新测试

---

## 📝 报告格式

请将诊断结果按以下格式报告：

```
=== 诊断结果 ===

步骤2（策略加载）: ✅/❌
步骤3（命令设置）: ✅/❌
步骤4.1（策略调用）: ✅/❌
步骤4.2（命令传递）: ✅/❌
步骤4.3（推理结果）: ✅/❌
步骤4.4（动作应用）: ✅/❌
步骤4.5（控制计算）: ✅/❌
步骤4.6（控制设置）: ✅/❌

问题描述：
[描述你看到的问题]

相关日志：
[复制相关的错误日志或异常日志]
```

---

## 🚀 开始诊断

1. **等待部署完成**（约 1-2 分钟）
2. **刷新页面**（F5）
3. **打开控制台**（F12）
4. **按照步骤逐一检查**

完成后告诉我诊断结果，我会根据结果帮你修复问题！

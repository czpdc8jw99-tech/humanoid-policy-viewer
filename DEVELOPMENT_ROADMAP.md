# Football Robot 后续研发步骤

> **重要提醒**：所有代码修改都将提交到 `https://github.com/czpdc8jw99-tech/humanoid-policy-viewer` 仓库

## 📋 当前已完成功能

### ✅ 1. 游戏手柄控制基础架构
- [x] ONNX 模型转换（`policy_loco_29dof.onnx`）
- [x] 策略配置文件（`loco_policy_29dof.json`）
- [x] 观察管道实现（`Command`, `JointPosRel`, `JointVel`, `PrevActions`）
- [x] 游戏手柄输入处理（`_updateGamepadCommand`, `applyDeadzone`, `scaleBipolar`）
- [x] UI 集成（游戏手柄状态显示、策略选择）

### ✅ 2. 核心代码实现
- [x] `PolicyRunner.setCommand()` - 命令输入接口
- [x] `main.js` 主循环集成游戏手柄更新
- [x] `Demo.vue` 条件渲染（运动跟踪 vs 命令驱动）
- [x] 观察模块（`observationHelpers.js`）

---

## 🔍 第一阶段：功能验证与测试

### 1.1 游戏手柄控制功能验证 ⚠️ **优先级：高**

**目标**：确保游戏手柄控制能够正常工作，机器人能够响应手柄输入进行行走

**步骤**：
1. **本地测试环境搭建**
   ```bash
   npm install
   npm run dev
   ```

2. **功能测试清单**：
   - [ ] 连接游戏手柄后，UI 显示 "Gamepad: connected"
   - [ ] 选择 "G1 Locomotion (Gamepad)" 策略
   - [ ] 左摇杆控制前进/后退/左右移动（vx, vy）
   - [ ] 右摇杆 X 轴控制转向（wz）
   - [ ] 机器人能够响应命令并开始行走
   - [ ] 命令值在 UI 中正确显示（格式：`vx: X.XX, vy: Y.YY, wz: Z.ZZ`）

3. **问题排查**：
   - 如果手柄未响应：检查浏览器控制台错误、Gamepad API 兼容性
   - 如果机器人不移动：检查观察向量构建、ONNX 推理、PD 控制参数
   - 如果移动异常：检查命令范围映射、死区设置、缩放函数

**预期输出**：
- 测试报告（成功/失败项）
- 发现的问题列表（如有）

---

### 1.2 观察向量验证 ⚠️ **优先级：高**

**目标**：确保 96 维观察向量构建正确

**步骤**：
1. **添加调试日志**（临时）：
   - 在 `PolicyRunner.step()` 中打印观察向量各部分的维度
   - 验证：`RootAngVelB` (3) + `ProjectedGravityB` (3) + `Command` (3) + `JointPosRel` (29) + `JointVel` (29) + `PrevActions` (29) = 96

2. **数值范围检查**：
   - `Command`: 应在 `cmd_range` 范围内
   - `JointPosRel`: 相对于 `default_joint_pos` 的差值
   - `JointVel`: 关节速度（合理范围）
   - `PrevActions`: 上一帧的动作（应在 `action_clip` 范围内）

**预期输出**：
- 观察向量维度验证通过
- 数值范围检查报告

---

### 1.3 多机器人模式兼容性测试 ⚠️ **优先级：中**

**目标**：确保游戏手柄控制在多机器人场景下正常工作

**步骤**：
1. 创建多机器人场景（2-3 个机器人）
2. 为所有机器人选择 "G1 Locomotion (Gamepad)" 策略
3. 验证：
   - [ ] 所有机器人都能响应同一个游戏手柄命令
   - [ ] 每个机器人独立执行策略推理
   - [ ] UI 正确显示游戏手柄状态

**预期输出**：
- 多机器人模式测试报告

---

## 🚀 第二阶段：功能优化与改进

### 2.1 游戏手柄控制优化

**2.1.1 命令平滑处理**
- [ ] 添加命令平滑滤波器（低通滤波），避免命令突变
- [ ] 实现命令加速度限制（ramp up/down）

**2.1.2 手柄映射配置化**
- [ ] 支持自定义手柄按键/摇杆映射
- [ ] 支持不同手柄类型的自动识别和映射（Xbox, PlayStation, 通用）

**2.1.3 命令范围调整**
- [ ] 添加 UI 滑块调整 `cmd_range`（实时预览）
- [ ] 保存用户偏好设置（localStorage）

---

### 2.2 策略性能优化

**2.2.1 ONNX 推理优化**
- [ ] 检查并优化 ONNX Runtime Web 执行提供者（WASM/WebGL）
- [ ] 添加推理时间统计（FPS 显示）

**2.2.2 观察计算优化**
- [ ] 减少不必要的数组拷贝
- [ ] 使用 TypedArray 优化数值计算

---

### 2.3 UI/UX 改进

**2.3.1 游戏手柄状态可视化**
- [ ] 添加摇杆位置可视化（2D 圆形指示器）
- [ ] 显示命令历史曲线图（vx, vy, wz 随时间变化）
- [ ] 添加手柄连接/断开提示音/动画

**2.3.2 策略切换优化**
- [ ] 策略切换时平滑过渡（避免机器人突然跳跃）
- [ ] 添加策略加载进度条

---

## 🎯 第三阶段：功能扩展

### 3.1 更多控制模式

**3.1.1 键盘控制**
- [ ] 实现 WASD 键盘控制（作为游戏手柄的替代）
- [ ] 支持方向键 + Q/E 转向

**3.1.2 触摸控制（移动端）**
- [ ] 虚拟摇杆（左：移动，右：转向）
- [ ] 触摸手势识别

**3.1.3 鼠标控制**
- [ ] 鼠标点击地面设置目标点
- [ ] 机器人自动导航到目标点

---

### 3.2 高级运动控制

**3.2.1 动作组合**
- [ ] 支持手柄按键触发预设动作（如：跳跃、蹲下、挥手）
- [ ] 动作可以与行走命令叠加

**3.2.2 速度模式切换**
- [ ] 慢速/正常/快速模式切换
- [ ] 跑步/走路模式切换

---

### 3.3 策略扩展

**3.3.1 更多 FSMDeploy_G1 策略**
- [ ] 研究并转换其他策略（如：`stand_mode`, `dance_mode`）
- [ ] 实现策略切换机制（手柄按键切换）

**3.3.2 自定义策略支持**
- [ ] 支持用户上传自定义 ONNX 模型
- [ ] 策略配置向导（UI 表单生成 `policy.json`）

---

## 🔧 第四阶段：代码质量与文档

### 4.1 代码重构

- [ ] 提取游戏手柄相关代码到独立模块（`gamepadController.js`）
- [ ] 统一错误处理机制
- [ ] 添加 TypeScript 类型定义（或 JSDoc 注释）

### 4.2 测试覆盖

- [ ] 单元测试（观察模块、命令处理）
- [ ] 集成测试（策略加载、推理流程）
- [ ] E2E 测试（游戏手柄控制完整流程）

### 4.3 文档完善

- [ ] API 文档（JSDoc）
- [ ] 用户手册（游戏手柄使用指南）
- [ ] 开发者指南（添加新策略的步骤）
- [ ] 更新 README.md（添加游戏手柄控制说明）

---

## 📊 优先级总结

| 阶段 | 优先级 | 预计时间 | 状态 |
|------|--------|----------|------|
| 第一阶段：功能验证 | 🔴 高 | 1-2 天 | ⏳ 待开始 |
| 第二阶段：优化改进 | 🟡 中 | 3-5 天 | ⏳ 待开始 |
| 第三阶段：功能扩展 | 🟢 低 | 1-2 周 | ⏳ 待开始 |
| 第四阶段：代码质量 | 🟡 中 | 3-5 天 | ⏳ 待开始 |

---

## 🎯 下一步行动

**立即开始**：
1. ✅ 确认远程仓库地址已更新为 `https://github.com/czpdc8jw99-tech/humanoid-policy-viewer`
2. ⏭️ **运行本地开发服务器，测试游戏手柄控制功能**
3. ⏭️ **记录测试结果和发现的问题**
4. ⏭️ **根据测试结果修复问题或优化代码**

---

## 📝 注意事项

1. **Git 提交规范**：
   - 每次提交前先 `git pull` 确保同步
   - 提交信息使用中文或英文，清晰描述改动
   - 相关改动一起提交，避免碎片化提交

2. **代码审查**：
   - 重要功能实现后，先本地测试再推送
   - 保持代码风格一致

3. **问题追踪**：
   - 发现的问题记录在 GitHub Issues
   - 修复后关闭对应 Issue

---

**最后更新**：2025-01-XX  
**维护者**：czpdc8jw99-tech
